# Shell Completions for netkit

This directory contains dynamic shell completions for the `netkit` (Network Automation Toolkit) command.
Supported shells:
- Bash (Linux/macOS)
- Zsh (Linux/macOS)
- fish (Linux/macOS)

## Features

The completions provide intelligent suggestions powered by the CLI itself:

- **Commands**: All netkit subcommands (info, run, list-*, etc.)
- **Device names**: Read from your active configuration
- **Device groups**: From the `device_groups` section
- **Command sequences**: Global, vendor, and device-specific sequences
- **Sequence groups**: Predefined groups of command sequences
- **Tags**: Available tags for tag-based operations
- **File paths**: Context-aware file completion for config files, firmware, etc.
- **Options**: All command-line options and flags

## Installation

### Automatic Installation (Recommended)

Use the provided installation script (supports bash/zsh/fish):

```bash
# Install system-wide (requires sudo)
./install_completion.sh --system

# Install for current user only
./install_completion.sh --user

# Show manual installation instructions
./install_completion.sh --manual

# Show help
./install_completion.sh --help
```

### Manual Installation (per shell)

#### Option 1: Source in your shell profile

Add this line to your `~/.bashrc`, `~/.bash_profile`, or `~/.profile`:

```bash
source "/path/to/bash_completion_netkit.sh"
```

For zsh, copy `zsh_completion_netkit.zsh` to one of your `$fpath` directories as `_netkit`, e.g.:

```bash
mkdir -p ~/.zsh/completions
cp zsh_completion_netkit.zsh ~/.zsh/completions/_netkit
echo 'fpath+=$HOME/.zsh/completions' >> ~/.zshrc
echo 'autoload -Uz compinit && compinit' >> ~/.zshrc
```

For fish, copy `fish_completion_netkit.fish`:

```bash
mkdir -p ~/.config/fish/completions
cp fish_completion_netkit.fish ~/.config/fish/completions/netkit.fish
```

#### Option 2: System-wide installation (bash)

Copy the completion file to the bash completion directory:

```bash
# Most Linux distributions
sudo cp bash_completion_netkit.sh /etc/bash_completion.d/netkit

# Some distributions use this path
sudo cp bash_completion_netkit.sh /usr/share/bash-completion/completions/netkit
```

#### Option 3: User-specific bash-completion

If you use bash-completion locally:

```bash
mkdir -p ~/.local/share/bash-completion/completions
cp bash_completion_netkit.sh ~/.local/share/bash-completion/completions/netkit
```

## Usage Examples

Once installed, you can use TAB completion with the `netkit` command:

### Basic Command Completion

```bash
netkit <TAB><TAB>
# Shows: info run list-devices ...

netkit list-<TAB><TAB>
# Shows: list-devices list-sequences list-groups ...
```

### Device Name Completion

```bash
netkit info <TAB><TAB>
# Shows: core1br core2br vpn1br sw-acc1 sw-dist1 ...

netkit run sw-<TAB><TAB>
# Shows: sw-acc1 sw-acc2 sw-dist1
```

### Group Name Completion (as run target)

```bash
netkit run <TAB><TAB>
# Shows device and group names
```

### Sequence Completion (via run)

```bash
netkit run sw-acc1 <TAB><TAB>
# Shows: health_check system_info interface_monitoring security_audit ...
# Plus device-specific sequences: interface_status

# Or use run with sequences (device or group)
netkit run sw-acc1 <TAB><TAB>
# Shows: commands or known sequences

netkit run core <TAB><TAB>
# Shows global sequences for groups
```

### Vendor/user-defined sequence completion

```bash
netkit run sw-acc1 <TAB><TAB>
# Includes vendor/user sequences resolved via device type
```

### File and Option Completion

```bash
netkit upload sw-acc1 <TAB>
# Shows file completion for local files

netkit info --<TAB><TAB>
# Shows: --config --verbose --help

netkit run --config <TAB><TAB>
# Shows *.yml and *.yaml files
```

## Configuration File Detection

The completion scripts automatically detect your configuration file:

1. Looks for `--config` or `-c` options in the current command
2. Falls back to `devices.yml` in the current directory
3. Asks the CLI for suggestions via a hidden `__complete` command

## Advanced Features

### Multi-level Completion

The completion is context-aware and provides different suggestions based on:

- The current command being typed
- The position of the cursor
- Previously typed arguments
- The configuration file contents

### Dynamic Engine

Completions are generated by the CLI on-the-fly, so:
- New devices/groups/sequences are available immediately
- Vendor and user-defined sequences are included when relevant
- No parsing logic duplicated in shell scripts

### Error Handling

The completion gracefully handles:

- Missing configuration files
- Malformed YAML (falls back to no completion)
- Permission issues
- Non-existent directories

## Troubleshooting

### Completion Not Working

1. **Check if completion is loaded:**
   ```bash
   complete -p netkit
   # Should show: complete -F _netkit netkit
   ```

2. **Manually load completion:**
   ```bash
   source /path/to/bash_completion_netkit.sh
   ```

3. **Check bash-completion is installed:**
   ```bash
   # Ubuntu/Debian
   sudo apt install bash-completion

   # RHEL/CentOS/Fedora
   sudo yum install bash-completion
   # or
   sudo dnf install bash-completion
   ```

### Configuration File Issues

1. **Verify YAML syntax:**
   ```bash
   netkit config-validate
   ```

2. **Check file permissions:**
   ```bash
   ls -la devices.yml
   ```

3. **Test with explicit config:**
   ```bash
   netkit --config /path/to/devices.yml info <TAB>
   ```

### Performance Issues

If completion is slow with large configuration files:

1. **Optimize YAML parsing** by simplifying the awk scripts
2. **Cache results** (future enhancement)
3. **Use a smaller configuration file** for testing

## Files

- `bash_completion_netkit.sh` - Main completion script
- `install_completion.sh` - Automated installation script
- `README.md` - This documentation

## Contributing

To improve the completion:

1. Test with various YAML configurations
2. Add support for new netkit commands
3. Improve performance for large config files
4. Add support for additional file types
5. Enhance error handling

## Related Commands

The completion also works with these command variations:
- `network-toolkit` (alternative name)
- `nt` (short alias)

---

**Note**: This completion requires bash 4.0+ and is tested on Linux and macOS with bash-completion 2.0+.
